<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Gestión de Cuentas Bancarias</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
        }

        h1 {
            text-align: center;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input, select, button, textarea {
            padding: 8px;
            width: 100%;
            max-width: 400px;
            margin-top: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f4f4f4;
        }

        .actions button {
            margin-right: 5px;
        }

        .form-section {
            border: 1px solid #ccc;
            padding: 15px;
            margin-top: 20px;
        }

        .message {
            margin-top: 10px;
            color: red;
        }
    </style>
</head>
<body>

    <h1>Gestión de Cuentas Bancarias</h1>

    <section>
        <label for="searchAccountNumber">Buscar cuenta por número:</label>
        <input type="text" id="searchAccountNumber" placeholder="Número de cuenta (10 dígitos)" maxlength="10" />
        <button onclick="getAccounts()">Buscar</button>
        <button onclick="getAccounts(true)">Listar todas</button>
    </section>

    <section>
        <h2>Listado de cuentas</h2>
        <table id="accountsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Número Cuenta</th>
                    <th>Propietario</th>
                    <th>Balance</th>
                    <th>Tipo Cuenta</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Se llenará con JS -->
            </tbody>
        </table>
    </section>

    <section class="form-section">
        <h2 id="formTitle">Crear Nueva Cuenta</h2>
        <input type="hidden" id="accountId" />
        <label for="accountNumber">Número de Cuenta (10 dígitos):</label>
        <input type="text" id="accountNumber" maxlength="10" />

        <label for="ownerName">Nombre del Propietario:</label>
        <input type="text" id="ownerName" maxlength="100" />

        <label for="balanceAmount">Balance Inicial:</label>
        <input type="number" id="balanceAmount" min="0" step="0.01" />

        <label for="accountType">Tipo de Cuenta:</label>
        <select id="accountType">
            <option value="A">Ahorros</option>
            <option value="C">Corriente</option>
        </select>

        <button onclick="submitForm()">Guardar</button>
        <button onclick="resetForm()" type="button">Cancelar</button>

        <div class="message" id="formMessage"></div>
    </section>

    <section class="form-section">
        <h2>Operaciones - Depositar / Retirar</h2>
        <label for="transactionAccountNumber">Número de Cuenta (10 dígitos):</label>
        <input type="text" id="transactionAccountNumber" maxlength="10" />

        <label for="transactionAmount">Monto:</label>
        <input type="number" id="transactionAmount" min="0.01" step="0.01" />

        <button onclick="deposit()">Depositar</button>
        <button onclick="withdraw()">Retirar</button>

        <div class="message" id="transactionMessage"></div>
    </section>

    <script>
        const API_BASE = 'http://localhost:7000'; 

async function getAccounts(showAll = false) {
    const filter = document.getElementById('searchAccountNumber').value.trim();
    let url = API_BASE;
    if (!showAll && filter.length === 10) {
        url += '?accountNumber=' + filter;
    }

    try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Error al obtener cuentas');
        const accounts = await res.json();
        populateTable(accounts);
    } catch (error) {
        alert(error.message);
    }
}

function populateTable(accounts) {
    const tbody = document.querySelector('#accountsTable tbody');
    tbody.innerHTML = '';

    if (!Array.isArray(accounts)) accounts = [accounts]; // Por si viene una sola cuenta

    accounts.forEach(acc => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${acc.id}</td>
            <td>${acc.accountNumber}</td>
            <td>${acc.ownerName}</td>
            <td>${acc.balanceAmount.toFixed(2)}</td>
            <td>${acc.accountType}</td>
            <td class="actions">
                <button onclick="editAccount(${acc.id})">Editar</button>
                <button onclick="deleteAccount(${acc.id})">Eliminar</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function editAccount(id) {
    try {
        const res = await fetch(`${API_BASE}/${id}`);
        if (!res.ok) throw new Error('Cuenta no encontrada');
        const acc = await res.json();

        document.getElementById('accountId').value = acc.id;
        document.getElementById('accountNumber').value = acc.accountNumber;
        document.getElementById('ownerName').value = acc.ownerName;
        document.getElementById('balanceAmount').value = acc.balanceAmount;
        document.getElementById('accountType').value = acc.accountType;
        document.getElementById('formTitle').innerText = 'Editar Cuenta';
        document.getElementById('formMessage').innerText = '';
    } catch (error) {
        alert(error.message);
    }
}

function resetForm() {
    document.getElementById('accountId').value = '';
    document.getElementById('accountNumber').value = '';
    document.getElementById('ownerName').value = '';
    document.getElementById('balanceAmount').value = 0;
    document.getElementById('accountType').value = 'A';
    document.getElementById('formTitle').innerText = 'Crear Nueva Cuenta';
    document.getElementById('formMessage').innerText = '';
}

async function submitForm() {
    const id = document.getElementById('accountId').value;
    const accountNumber = document.getElementById('accountNumber').value.trim();
    const ownerName = document.getElementById('ownerName').value.trim();
    const balanceAmount = parseFloat(document.getElementById('balanceAmount').value);
    const accountType = document.getElementById('accountType').value;

    if (!accountNumber || accountNumber.length !== 10 || !/^\d{10}$/.test(accountNumber)) {
        return showMessage('El número de cuenta debe tener 10 dígitos numéricos', true);
    }
    if (!ownerName) {
        return showMessage('El nombre del propietario es requerido', true);
    }
    if (isNaN(balanceAmount) || balanceAmount < 0) {
        return showMessage('El balance debe ser un número positivo', true);
    }
    if (!['A', 'C'].includes(accountType)) {
        return showMessage('El tipo de cuenta debe ser A (Ahorros) o C (Corriente)', true);
    }

    const payload = {
        id: id ? parseInt(id) : 0,
        accountNumber, ownerName, balanceAmount, accountType
    };

    try {
        let response;
        if (id) {
            response = await fetch(`${API_BASE}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.errors?.join(', ') || 'Error al actualizar');
            }
            showMessage('Cuenta actualizada con éxito', false);
        } else {
            response = await fetch(API_BASE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.errors?.join(', ') || 'Error al crear');
            }
            showMessage('Cuenta creada con éxito', false);
        }
        resetForm();
        getAccounts(true);
    } catch (error) {
        showMessage(error.message, true);
    }
}

async function deleteAccount(id) {
    if (!confirm('¿Seguro que desea eliminar esta cuenta?')) return;

    try {
        const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.errors?.join(', ') || 'Error al eliminar');
        }
        alert('Cuenta eliminada');
        getAccounts(true);
    } catch (error) {
        alert(error.message);
    }
}

function showMessage(msg, isError) {
    const el = document.getElementById('formMessage');
    el.style.color = isError ? 'red' : 'green';
    el.textContent = msg;
}

// --- Sección de depósitos y retiros ---

async function deposit() {
    await makeTransaction('deposit');
}

async function withdraw() {
    await makeTransaction('withdraw');
}

async function makeTransaction(type) {
    const accountNumber = document.getElementById('transactionAccountNumber').value.trim();
    const valueAmount = parseFloat(document.getElementById('transactionAmount').value);

    const msgEl = document.getElementById('transactionMessage');
    msgEl.style.color = 'red';
    msgEl.textContent = '';

    if (!accountNumber || accountNumber.length !== 10 || !/^\d{10}$/.test(accountNumber)) {
        msgEl.textContent = 'El número de cuenta debe tener 10 dígitos numéricos';
        return;
    }
    if (isNaN(valueAmount) || valueAmount <= 0) {
        msgEl.textContent = 'El monto debe ser mayor que cero';
        return;
    }

    // Necesitamos obtener el id de la cuenta para las operaciones (la API usa id en URL)
    try {
        // Buscar cuenta por número para obtener su id
        const resSearch = await fetch(`${API_BASE}?accountNumber=${accountNumber}`);
        if (!resSearch.ok) throw new Error('Cuenta no encontrada');
        const accounts = await resSearch.json();
        if (!accounts || (Array.isArray(accounts) && accounts.length === 0)) throw new Error('Cuenta no encontrada');
        const account = Array.isArray(accounts) ? accounts[0] : accounts;

        // Crear el objeto TransactionDto
        const transactionDto = {
            accountId: account.id,
            valueAmount: valueAmount
        };

        let endpoint = '';
        if (type === 'deposit') endpoint = `${API_BASE}/deposit`;
        else if (type === 'withdraw') endpoint = `${API_BASE}/withdraw`;
        else throw new Error('Tipo de operación inválido');

        const resOp = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(transactionDto)
        });

        if (!resOp.ok) {
            const err = await resOp.json();
            throw new Error(err.errors?.join(', ') || 'Error en la operación');
        }

        msgEl.style.color = 'green';
        msgEl.textContent = `${type === 'deposit' ? 'Depósito' : 'Retiro'} realizado con éxito`;

        // Refrescar listado
        getAccounts(true);
    } catch (error) {
        msgEl.textContent = error.message;
    }
}

window.onload = () => {
    getAccounts(true);
};
    </script>

</body>
</html>
